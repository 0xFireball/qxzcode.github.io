<!doctype html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width" />
  <title>CoH Master</title>
  <style>
@charset "UTF-8";

body {
  font-family: helvetica;
  background-color: #DDD;
}
h4 {
  color: #555;
}
h1,h4,h3 {
  text-align: center;
  margin: 10px;
}
#link {
  color: black;
  font-weight: normal;
  margin: 1px;
}
h3 {
  margin-top: 15px;
  margin-bottom: 1px;
}

#outdiv {
  display: none;
}
input {
  width: 0.1px;
  height: 0.1px;
  opacity: 0;
  overflow: hidden;
  position: absolute;
  z-index: -1;
}
label {
  cursor: pointer;
  color: white;
  background-color: #22E;
  font-weight: bold;
  border-radius: 5px;
  padding: 10px;
  margin-bottom: 6px;
  display: inline-block;
}
textarea {
  width: 100%;
  font-family: courier;
  tab-size: 4;
  padding: 5px;
}
  </style>
  <script>
function parse() {try{
  var str = document.getElementById("in").value;
  
  /* parse lines into data */
  var award, awardType, scout=true;
  var data = {};
  var lines = str.split("\n");
  for (var li in lines) {
    var line = lines[li].trim(), lline = line.toLowerCase();
    if (line=="") continue;
    if (/^\d+\/\d+\/\d+/.test(line)) continue;
    if (/^troop \d+ court of honor/i.test(line)) continue;
    if (/^[PR#]\s+-/i.test(line)) continue;
    if (lline=="awards summary") break;
    if (lline=="scout awards") {scout=true;continue}
    if (lline=="adult leader awards") {scout=false;continue}
    
    var am = line.match(/([^*:]+?)\*?\s*:/);
    if (am && awardType) {
      if (!data[awardType][award=am[1]])
        data[awardType][award] = [];
    }
    var nm = line.match(/(?:^|:)\s*([^:,]+),\s*(\D+?)\s+\d+\//);
    if (nm) {
      if (!data[awardType][award]) {
        alert(awardType+" | "+nm);
        return debug;
      }
      data[awardType][award].push({name:nm[2]+" "+nm[1],scout:scout});
    } else {
      if (!data[awardType=line])
        data[awardType] = {};
    }
  }
  
  /* process data to generate report */
  var out = "";
  var error = "";
  function pl(n){return n==1?"":"s"}
  for (awardType in data) {
    var lat = awardType.toLowerCase();
    if (!/^(merit badges|ranks|special awards|service stars)$/.test(lat))
      error += 'Unknown award type: "'+awardType+'"\n';
    out += "\n== "+awardType+" ==\n\n";
    var as = data[awardType];
    if (lat=="merit badges") {
      var scouts = [];
      for (award in as) {
        var ps=as[award];
        for (var i in ps) {
          if (!scouts[ps[i].name])
            scouts[ps[i].name] = [];
          scouts[ps[i].name].push(award);
        }
      }
      var num = {};
      for (var n in scouts) {
        if (!num[scouts[n].length])
          num[scouts[n].length] = [];
        num[scouts[n].length].push({name:n,mbs:scouts[n]});
      }
      for (var n in num) {
        out += num[n].length+" scout"+pl(num[n].length);
        out += " who earned "+n+" merit badge"+pl(n)+":\n";
        for (var i in num[n]) {
          out += "\t"+num[n][i].name+":\n\t\t";
          out += num[n][i].mbs.join("\n\t\t")+"\n";
        }
        out += "\n";
      }
    } else {
      for (award in as) {
        var ps=as[award];
        out += award+":\n";
        var scouts=[],adults=[];
        for (var i in ps)
          (ps[i].scout?scouts:adults).push(ps[i].name);
        var head="\t",body=":\n\t\t";
        if (scouts.length>0) {
          head += scouts.length+" scout"+pl(scouts.length);
          if (adults.length>0) head += " and ";
          body += scouts.join("\n\t\t")+"\n";
        }
        if (adults.length>0) {
          head += adults.length+" adult"+pl(adults.length);
          if (scouts.length>0) body += "\n\t\t";
          body += adults.join("\n\t\t")+"\n";
        }
        out += head+body+"\n";
      }
    }
  }
 
  /* output the result */
  if (error!="")
    out = "There were error(s) while parsing the file; the output may not be valid.\n"+error+"\n"+out;
  document.getElementById("out").value = out;
  document.getElementById("link").innerHTML='(<a href="data:text/plain,'+encodeURIComponent(out)+'" target="_blank">File for saving</a>)<br>';
  document.getElementById("outdiv").style.display = "initial";
}catch(e){alert("Serious error: "+e.message)}}

function onFile(ele) {
  var file = ele.files[0];
  if (file.type!="text/plain") {
    alert("Please choose a plain text (.txt) file");
    return;
  }
  var fr = new FileReader();
  fr.onload = function() {
    document.getElementById("in").value = fr.result;
    parse();
  };
  fr.readAsText(file);
}
  </script>
</head>
<body>
  <h1>CoH Master</h1>
  <h4>by Quinn Tucker</h4>
  <input type="file" id="file" onchange="onFile(this)"/>
  <label for="file">Choose a file</label><br>
  <textarea rows="10" id="in" oninput="parse()" placeholder="Or paste the text here!"></textarea><br>
  <div id="outdiv">
  <h3>Output</h3>
  <h4 id="link"></h4><br>
  <textarea rows="25" id="out"></textarea>
  </div>
</body>
</html>
